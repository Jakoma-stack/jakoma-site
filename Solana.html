<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Solana Quant Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: #0b0c10; color: #eaeaea; font-family: 'Inter', sans-serif; }
    .card { background: #1f2833; border: none; border-radius: 1rem; color: #fff; }
    .value { font-size: 1.6rem; font-weight: bold; }
    h1 { margin-bottom: 1rem; color: #66fcf1; }
    hr { border-color: #45a29e; }
    footer { margin-top: 2rem; color: #c5c6c7; }
  </style>
</head>
<body class="p-4">
  <div class="container">
    <h1 class="text-center">ğŸ“Š Solana Quant Dashboard</h1>

    <!-- KPI Grid -->
    <div class="row g-3 text-center">
      <div class="col-md-3"><div class="card p-3"><div>ğŸª™ Tokens Tracked</div><div id="tokens-tracked" class="value">-</div></div></div>
      <div class="col-md-3"><div class="card p-3"><div>ğŸš€ Pumps Detected</div><div id="pumps-detected" class="value">-</div></div></div>
      <div class="col-md-3"><div class="card p-3"><div>ğŸ”» Retraces</div><div id="retraces-detected" class="value">-</div></div></div>
      <div class="col-md-3"><div class="card p-3"><div>ğŸ”„ Open Trades</div><div id="open-trades" class="value">-</div></div></div>

      <div class="col-md-3"><div class="card p-3"><div>ğŸ’° Total PnL</div><div id="total-pnl" class="value">-</div></div></div>
      <div class="col-md-3"><div class="card p-3"><div>ğŸ’µ Realised PnL</div><div id="realised-pnl" class="value">-</div></div></div>
      <div class="col-md-3"><div class="card p-3"><div>ğŸ“ˆ Unrealised PnL</div><div id="unrealised-pnl" class="value">-</div></div></div>
      <div class="col-md-3"><div class="card p-3"><div>ğŸ† Win Rate</div><div id="win-rate" class="value">-</div></div></div>
    </div>

    <hr class="my-4">

    <!-- Chart placeholders -->
    <h4>ğŸ“… Daily PnL Trend</h4>
    <canvas id="dailyChart"></canvas>

    <h4 class="mt-5">ğŸª™ Top Tokens by Profit</h4>
    <canvas id="tokenChart"></canvas>

    <hr class="my-4">

    <!-- Last updated footer -->
    <footer class="text-center">
      <p id="last-updated" class="text-muted">Loading update time...</p>
    </footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    async function fetchJSON(url) {
      const res = await fetch(url + '?' + new Date().getTime());
      if (!res.ok) throw new Error('Failed to load ' + url);
      return res.json();
    }

    async function fetchCSV(url) {
      const res = await fetch(url + '?' + new Date().getTime());
      if (!res.ok) throw new Error('Failed to load ' + url);
      return res.text();
    }

    async function updateDashboard() {
      try {
        const [status, trades] = await Promise.all([
          fetchJSON('data/solana_status.json'),
          fetchJSON('data/solana_trades.json')
        ]);

        // Update KPIs
        document.getElementById('tokens-tracked').innerText = status.tokens_tracked ?? '-';
        document.getElementById('pumps-detected').innerText = status.pumps_detected ?? '-';
        document.getElementById('retraces-detected').innerText = status.retraces_detected ?? '-';
        document.getElementById('open-trades').innerText = trades.open_trades ?? '-';
        document.getElementById('total-pnl').innerText = `$${(status.total_pnl ?? 0).toFixed(2)}`;
        document.getElementById('realised-pnl').innerText = `$${(trades.realised_pnl ?? 0).toFixed(2)}`;
        document.getElementById('unrealised-pnl').innerText = `$${(trades.unrealised_pnl ?? 0).toFixed(2)}`;
        document.getElementById('win-rate').innerText = `${(trades.win_rate ?? 0).toFixed(1)}%`;

        // ğŸ•’ Display last updated timestamp
        document.getElementById('last-updated').innerText =
          "Last updated: " + (status.last_updated || "unknown");

      } catch (err) {
        console.error('Dashboard update failed:', err);
      }
    }

    async function renderCharts() {
      try {
        const dailyCSV = await fetchCSV('data/pnl_daily_summary.csv');
        const tokenCSV = await fetchCSV('data/pnl_by_token.csv');

        const parseCSV = (text) => {
          const [header, ...rows] = text.trim().split('\n');
          const cols = header.split(',');
          return rows.map(r => {
            const vals = r.split(',');
            return Object.fromEntries(cols.map((c, i) => [c.trim(), vals[i]]));
          });
        };

        const dailyData = parseCSV(dailyCSV);
        const tokenData = parseCSV(tokenCSV);

        if (window.dailyChartObj) window.dailyChartObj.destroy();
        if (window.tokenChartObj) window.tokenChartObj.destroy();

        // Daily PnL Trend
        window.dailyChartObj = new Chart(document.getElementById('dailyChart'), {
          type: 'line',
          data: {
            labels: dailyData.map(d => d.date),
            datasets: [{
              label: 'Total PnL ($)',
              data: dailyData.map(d => parseFloat(d.total_pnl || 0)),
              borderColor: '#66fcf1',
              backgroundColor: 'rgba(102,252,241,0.2)',
              tension: 0.3,
              fill: true
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });

        // Token Profit Bar Chart
        const topTokens = tokenData.slice(0, 10);
        window.tokenChartObj = new Chart(document.getElementById('tokenChart'), {
          type: 'bar',
          data: {
            labels: topTokens.map(t => t.token),
            datasets: [{
              label: 'Total Profit ($)',
              data: topTokens.map(t => parseFloat(t.total_profit || 0)),
              backgroundColor: '#45a29e'
            }]
          },
          options: { responsive: true, scales: { y: { beginAtZero: true } } }
        });
      } catch (err) {
        console.error('Chart render failed:', err);
      }
    }

    // Initial load
    updateDashboard();
    renderCharts();

    // Auto-refresh every 5 minutes
    setInterval(() => {
      updateDashboard();
      renderCharts();
    }, 5 * 60 * 1000);
  </script>
</body>
</html>
